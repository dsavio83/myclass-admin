<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Flow Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        
        .log-entry {
            font-size: 12px;
            color: #6c757d;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Upload Flow Test Suite</h1>
    <p>Test the complete two-step upload process: Cloudinary upload + MongoDB save</p>
    
    <div class="card">
        <h3>ğŸ“‹ Test Configuration</h3>
        <div class="test-section">
            <label>Lesson ID: </label>
            <input type="text" id="lessonId" value="676a12345678901234567890" style="width: 300px;">
            <br><br>
            <label>Resource Type: </label>
            <select id="resourceType">
                <option value="book">Book</option>
                <option value="video">Video</option>
                <option value="audio">Audio</option>
                <option value="worksheet">Worksheet</option>
                <option value="slide">Slide</option>
                <option value="notes">Notes</option>
            </select>
            <br><br>
            <label>Title: </label>
            <input type="text" id="title" value="Test Upload - " style="width: 300px;">
            <br><br>
            <label>Cloud Name: </label>
            <input type="text" id="cloudName" value="your-cloud-name" style="width: 300px;">
            <br><br>
            <label>Upload Preset: </label>
            <input type="text" id="uploadPreset" value="your-upload-preset" style="width: 300px;">
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ File Upload Test</h3>
        <div class="test-section">
            <input type="file" id="testFile" accept=".pdf,.jpg,.png,.mp4,.mp3">
            <button onclick="testFileValidation()">âœ… Test File Validation</button>
            <button onclick="testDuplicateCheck()">ğŸ” Test Duplicate Check</button>
            <button onclick="testFullUpload()">ğŸš€ Test Full Upload</button>
            <button onclick="testCleanup()">ğŸ§¹ Test Cleanup</button>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="uploadStatus" class="status-info">Ready to test</div>
            
            <div class="test-result" id="testResult"></div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š Test Logs</h3>
        <div id="testLogs" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px;"></div>
    </div>

    <div class="card">
        <h3>ğŸ”§ Manual Tests</h3>
        <div class="test-section">
            <h4>1. File Validation Tests</h4>
            <button onclick="testLargeFile()">ğŸ“ Test Large File (16MB)</button>
            <button onclick="testInvalidType()">âŒ Test Invalid File Type</button>
            <button onclick="testValidFile()">âœ… Test Valid File</button>
            
            <h4>2. Upload Process Tests</h4>
            <button onclick="testCloudinaryOnly()">â˜ï¸ Test Cloudinary Upload Only</button>
            <button onclick="testDatabaseOnly()">ğŸ’¾ Test Database Save Only</button>
            <button onclick="testErrorHandling()">âš ï¸ Test Error Handling</button>
            
            <h4>3. Edge Cases</h4>
            <button onclick="testNetworkFailure()">ğŸŒ Test Network Failure</button>
            <button onclick="testTimeout()">â±ï¸ Test Timeout</button>
            <button onclick="testDuplicateUpload()">ğŸ”„ Test Duplicate Upload</button>
        </div>
    </div>

    <script>
        // Test utilities
        const log = (message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'}">${type.toUpperCase()}</span>: ${message}`;
            document.getElementById('testLogs').appendChild(logEntry);
            document.getElementById('testLogs').scrollTop = document.getElementById('testLogs').scrollHeight;
        };

        const updateStatus = (message, type = 'info') => {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = `status-${type}`;
        };

        const updateProgress = (percentage) => {
            document.getElementById('progressFill').style.width = `${percentage}%`;
        };

        const setResult = (result) => {
            document.getElementById('testResult').textContent = JSON.stringify(result, null, 2);
        };

        // Configuration
        const getConfig = () => ({
            lessonId: document.getElementById('lessonId').value,
            resourceType: document.getElementById('resourceType').value,
            title: document.getElementById('title').value + new Date().toISOString().slice(11, 19),
            cloudName: document.getElementById('cloudName').value,
            uploadPreset: document.getElementById('uploadPreset').value
        });

        // Test functions
        async function testFileValidation() {
            log('Starting file validation test...');
            updateStatus('Testing file validation...', 'info');
            
            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('Please select a file first', 'error');
                log('No file selected', 'error');
                return;
            }

            // Simulate file validation
            const maxSize = 15 * 1024 * 1024; // 15MB
            const allowedTypes = [
                'application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 
                'image/gif', 'video/mp4', 'audio/mpeg', 'audio/wav'
            ];

            let isValid = true;
            let error = '';

            if (file.size > maxSize) {
                isValid = false;
                error = `File too large: ${(file.size / (1024 * 1024)).toFixed(2)}MB (max 15MB)`;
            } else if (!allowedTypes.includes(file.type)) {
                isValid = false;
                error = `Invalid file type: ${file.type}`;
            }

            if (isValid) {
                updateStatus('âœ… File validation passed', 'success');
                log(`File validation passed: ${file.name} (${(file.size / 1024).toFixed(2)}KB)`, 'success');
            } else {
                updateStatus(`âŒ File validation failed: ${error}`, 'error');
                log(`File validation failed: ${error}`, 'error');
            }
        }

        async function testDuplicateCheck() {
            log('Starting duplicate check test...');
            updateStatus('Checking for duplicates...', 'info');

            const config = getConfig();
            
            try {
                // Simulate duplicate check API call
                const response = await fetch(`/api/content/check-duplicate?lessonId=${config.lessonId}&title=${encodeURIComponent(config.title)}&type=${config.resourceType}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.isDuplicate) {
                        updateStatus('âš ï¸ Duplicate content detected', 'warning');
                        log('Duplicate content found', 'warning');
                    } else {
                        updateStatus('âœ… No duplicates found', 'success');
                        log('No duplicate content', 'success');
                    }
                    setResult(result);
                } else {
                    throw new Error('Duplicate check failed');
                }
            } catch (error) {
                updateStatus('âš ï¸ Could not check duplicates', 'warning');
                log(`Duplicate check error: ${error.message}`, 'error');
            }
        }

        async function testCloudinaryOnly() {
            log('Starting Cloudinary upload test...');
            updateStatus('Uploading to Cloudinary...', 'info');

            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            const config = getConfig();

            if (!file) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            try {
                // Simulate Cloudinary upload
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', config.uploadPreset);

                // Mock progress tracking
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    updateProgress(progress);
                    if (progress >= 100) clearInterval(progressInterval);
                }, 100);

                // Simulate API call
                const response = await fetch(`https://api.cloudinary.com/v1_1/${config.cloudName}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                updateProgress(100);

                if (response.ok) {
                    const result = await response.json();
                    updateStatus('âœ… Cloudinary upload successful', 'success');
                    log(`Cloudinary upload successful: ${result.public_id}`, 'success');
                    setResult({ cloudinaryResult: result });
                } else {
                    throw new Error('Cloudinary upload failed');
                }
            } catch (error) {
                updateStatus('âŒ Cloudinary upload failed', 'error');
                log(`Cloudinary upload error: ${error.message}`, 'error');
            }
        }

        async function testDatabaseOnly() {
            log('Starting database save test...');
            updateStatus('Saving to database...', 'info');

            const config = getConfig();

            try {
                const response = await fetch('/api/content/cloudinary-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lessonId: config.lessonId,
                        title: config.title,
                        type: config.resourceType,
                        fileUrl: 'https://example.com/test.pdf',
                        publicId: 'test_public_id',
                        size: 1024,
                        mimeType: 'application/pdf',
                        resourceType: 'image'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    updateStatus('âœ… Database save successful', 'success');
                    log('Database save successful', 'success');
                    setResult({ databaseResult: result });
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Database save failed');
                }
            } catch (error) {
                updateStatus('âŒ Database save failed', 'error');
                log(`Database save error: ${error.message}`, 'error');
            }
        }

        async function testFullUpload() {
            log('Starting full upload test...');
            updateStatus('Starting full upload process...', 'info');

            const fileInput = document.getElementById('testFile');
            const file = fileInput.files[0];
            const config = getConfig();

            if (!file) {
                updateStatus('Please select a file first', 'error');
                return;
            }

            try {
                // Step 1: Check duplicates
                updateStatus('Step 1: Checking for duplicates...', 'info');
                log('Step 1: Checking for duplicates...');
                
                const duplicateResponse = await fetch(`/api/content/check-duplicate?lessonId=${config.lessonId}&title=${encodeURIComponent(config.title)}&type=${config.resourceType}`);
                if (duplicateResponse.ok) {
                    const duplicateResult = await duplicateResponse.json();
                    if (duplicateResult.isDuplicate) {
                        updateStatus('âš ï¸ Duplicate content detected - upload cancelled', 'warning');
                        log('Duplicate content detected - upload cancelled', 'warning');
                        return;
                    }
                }

                // Step 2: Upload to Cloudinary
                updateStatus('Step 2: Uploading to Cloudinary...', 'info');
                log('Step 2: Uploading to Cloudinary...');

                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', config.uploadPreset);

                let cloudResult;
                try {
                    const cloudResponse = await fetch(`https://api.cloudinary.com/v1_1/${config.cloudName}/auto/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!cloudResponse.ok) throw new Error('Cloudinary upload failed');
                    cloudResult = await cloudResponse.json();
                    
                    updateStatus('Step 2: Cloudinary upload successful', 'success');
                    log(`Step 2: Cloudinary upload successful - ${cloudResult.public_id}`);
                } catch (cloudError) {
                    updateStatus('âŒ Cloudinary upload failed - stopping upload', 'error');
                    log(`Step 2: Cloudinary upload failed - ${cloudError.message}`, 'error');
                    throw cloudError;
                }

                // Step 3: Save to database
                updateStatus('Step 3: Saving to database...', 'info');
                log('Step 3: Saving to database...');

                const saveResponse = await fetch('/api/content/cloudinary-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lessonId: config.lessonId,
                        title: config.title,
                        type: config.resourceType,
                        fileUrl: cloudResult.secure_url,
                        publicId: cloudResult.public_id,
                        size: cloudResult.bytes,
                        mimeType: file.type,
                        resourceType: cloudResult.resource_type
                    })
                });

                if (!saveResponse.ok) {
                    // Cleanup Cloudinary file if database save fails
                    log('Step 3: Database save failed - cleaning up Cloudinary file...');
                    await fetch('/api/cloudinary/cleanup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            publicId: cloudResult.public_id,
                            resourceType: cloudResult.resource_type
                        })
                    });
                    throw new Error('Database save failed');
                }

                const saveResult = await saveResponse.json();
                
                // Success!
                updateStatus('ğŸ‰ Upload completed successfully!', 'success');
                log('Step 3: Database save successful');
                log('ğŸ‰ Full upload process completed successfully!');
                
                setResult({
                    cloudinaryResult: cloudResult,
                    databaseResult: saveResult,
                    finalStatus: 'success'
                });

            } catch (error) {
                updateStatus('âŒ Upload failed', 'error');
                log(`Upload failed: ${error.message}`, 'error');
                
                setResult({
                    error: error.message,
                    finalStatus: 'failed'
                });
            }
        }

        async function testCleanup() {
            log('Starting cleanup test...');
            updateStatus('Testing cleanup process...', 'info');

            try {
                const response = await fetch('/api/cloudinary/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        publicId: 'test_cleanup_id',
                        resourceType: 'image'
                    })
                });

                if (response.ok) {
                    updateStatus('âœ… Cleanup successful', 'success');
                    log('Cleanup test successful', 'success');
                } else {
                    throw new Error('Cleanup failed');
                }
            } catch (error) {
                updateStatus('âŒ Cleanup failed', 'error');
                log(`Cleanup error: ${error.message}`, 'error');
            }
        }

        // Edge case tests
        function testLargeFile() {
            log('Testing large file validation...');
            updateStatus('Testing large file validation...', 'info');
            
            // Create a large file blob for testing
            const largeFile = new Blob(['x'.repeat(16 * 1024 * 1024)], { type: 'application/pdf' });
            const file = new File([largeFile], 'large-test.pdf', { type: 'application/pdf' });
            
            log(`Created test file: ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)}MB)`);
            updateStatus('Large file test completed - check validation logic', 'info');
        }

        function testInvalidType() {
            log('Testing invalid file type...');
            updateStatus('Testing invalid file type...', 'info');
            
            const invalidFile = new File(['test'], 'test.exe', { type: 'application/octet-stream' });
            log(`Created invalid file: ${invalidFile.name} (${invalidFile.type})`);
            updateStatus('Invalid type test completed - check validation logic', 'info');
        }

        function testValidFile() {
            log('Testing valid file...');
            updateStatus('Testing valid file...', 'info');
            
            const validFile = new File(['test'], 'test.pdf', { type: 'application/pdf' });
            log(`Created valid file: ${validFile.name} (${validFile.type})`);
            updateStatus('Valid file test completed - check validation logic', 'info');
        }

        function testNetworkFailure() {
            log('Testing network failure handling...');
            updateStatus('Simulating network failure...', 'warning');
            
            // This would be tested by disconnecting network or using dev tools
            log('Network failure test - manually test by disabling network');
            updateStatus('Network failure test completed - manual verification needed', 'info');
        }

        function testTimeout() {
            log('Testing timeout handling...');
            updateStatus('Testing timeout handling...', 'info');
            
            // Simulate timeout by creating a long-running operation
            setTimeout(() => {
                log('Timeout test completed');
                updateStatus('Timeout test completed', 'info');
            }, 5000);
        }

        function testDuplicateUpload() {
            log('Testing duplicate upload prevention...');
            updateStatus('Testing duplicate upload prevention...', 'info');
            
            // This would test uploading the same file twice
            log('Duplicate upload test - manually test by uploading same file twice');
            updateStatus('Duplicate upload test completed - manual verification needed', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Upload flow test suite loaded', 'success');
            updateStatus('Test suite ready', 'success');
        });
    </script>
</body>
</html>